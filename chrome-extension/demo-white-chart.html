<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LS Stock Ticker - White Theme Chart Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .instrument-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ff00ff;
        }
        
        .instrument-info h2 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .instrument-info .details {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .instrument-info .detail-item {
            color: #666;
        }
        
        .instrument-info .detail-item strong {
            color: #333;
        }
        
        .price-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .current-price {
            font-size: 24px;
            font-weight: bold;
            color: #ff00ff;
        }
        
        .price-change {
            font-size: 18px;
            color: #28a745;
        }
        
        .price-change.negative {
            color: #dc3545;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #ff00ff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #e600e6;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #666;
        }
        
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .feature-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #ff00ff;
        }
        
        .feature-item h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .feature-item p {
            margin: 0;
            color: #666;
            line-height: 1.5;
        }
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="header">
        <h1>üìà LS Stock Ticker - White Theme Chart Demo</h1>
        <p>Professional real-time stock chart with neon price line and volume visualization</p>
    </div>
    
    <div class="demo-container">
        <!-- Instrument Information (simulating .informerhead) -->
        <div class="instrument-info informerhead">
            <h2>Rheinmetall AG</h2>
            <div class="details">
                <div class="detail-item">
                    <strong>ISIN:</strong> DE0007030009
                </div>
                <div class="detail-item">
                    <strong>WKN:</strong> 703000
                </div>
                <div class="detail-item">
                    <strong>Symbol:</strong> RHM
                </div>
                <div class="detail-item">
                    <strong>Currency:</strong> EUR
                </div>
            </div>
        </div>
        
        <!-- Current Price Display -->
        <div class="price-display">
            <div>
                <div class="current-price" id="current-price">‚Ç¨1,623.50</div>
                <div>Last Update: <span id="last-update">14:30:15</span></div>
            </div>
            <div>
                <div class="price-change" id="price-change">+12.30 (+0.76%)</div>
                <div style="font-size: 12px; color: #666;">vs. Previous Close</div>
            </div>
        </div>
        
        <!-- Demo Controls -->
        <div class="controls">
            <button class="btn btn-primary" onclick="startDemo()">üöÄ Start Live Demo</button>
            <button class="btn btn-success" onclick="simulateBuyTrade()">üìà Simulate Buy Trade</button>
            <button class="btn btn-danger" onclick="simulateSellTrade()">üìâ Simulate Sell Trade</button>
            <button class="btn btn-secondary" onclick="clearChart()">üßπ Clear Chart</button>
        </div>
        
        <!-- Status Display -->
        <div class="status success" id="status">
            ‚úÖ Chart initialized successfully with white theme and neon price line
        </div>
        
        <!-- Time Verification -->
        <div class="status info" id="timeStatus" style="margin-top: 10px; font-size: 12px;">
            üïê Current Local Time: <span id="currentTime">--</span>
        </div>
        
        <!-- Chart Container (will be injected here) -->
        <div id="chart-placement"></div>
        
        <!-- Feature Overview -->
        <div class="feature-list">
            <div class="feature-item">
                <h3>üé® White Theme</h3>
                <p>Clean, professional white background with optimal contrast for financial data visualization.</p>
            </div>
            
            <div class="feature-item">
                <h3>üíñ Neon Price Line</h3>
                <p>Eye-catching magenta price line that stands out clearly against the white background.</p>
            </div>
            
            <div class="feature-item">
                <h3>üìä Volume Bars</h3>
                <p>Color-coded volume visualization with green for buy orders, red for sell orders.</p>
            </div>
            
            <div class="feature-item">
                <h3>‚ö° Real-time Updates</h3>
                <p>Live price and trade data integration with LightstreamerClient for instant market updates.</p>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>LS Stock Ticker Chrome Extension Demo ‚Ä¢ White Theme with Professional Styling</p>
        <p>Powered by LightweightCharts Library v4.1.3</p>
    </div>

    <script>
        class DemoChart {
            constructor() {
                this.chart = null;
                this.lineSeries = null;
                this.volumeSeries = null;
                this.priceData = [];
                this.volumeData = [];
                this.tradeTooltipData = new Map(); // Store trade data for tooltips
                this.basePrice = 1623.50;
                this.currentPrice = this.basePrice;
                this.isRunning = false;
                this.intervalId = null;
                
                this.init();
            }
            
            init() {
                this.createChartContainer();
                this.initializeChart();
            }
            
            createChartContainer() {
                const targetContainer = document.getElementById('chart-placement');
                
                // Create chart container (matching the extension's styling)
                const chartContainer = document.createElement('div');
                chartContainer.id = 'realtime-chart-DE0007030009';
                chartContainer.style.cssText = `
                    width: 100%;
                    background: #ffffff;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    margin: 20px 0;
                    padding: 15px;
                    position: relative;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                `;
                
                // Chart div
                const chartDiv = document.createElement('div');
                chartDiv.id = 'realtime-chart-DE0007030009-chart';
                chartDiv.style.cssText = `
                    width: 100%;
                    height: 400px;
                    background: #ffffff;
                    border-radius: 4px;
                `;
                chartContainer.appendChild(chartDiv);
                
                // Chart controls
                const controls = document.createElement('div');
                controls.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-top: 10px;
                    color: #666;
                    font-size: 12px;
                `;
                
                const info = document.createElement('span');
                info.textContent = 'ISIN: DE0007030009 | WKN: 703000';
                
                const legend = document.createElement('span');
                legend.innerHTML = `
                    <span style="color: #ff00ff;">üìà Price Line</span> | 
                    <span style="color: #00ff00;">üü¢ Buy Volume</span> | 
                    <span style="color: #ff0000;">üî¥ Sell Volume</span> | 
                    <span style="color: #808080;">‚¨ú Unknown Volume</span>
                `;
                
                controls.appendChild(info);
                controls.appendChild(legend);
                chartContainer.appendChild(controls);
                
                targetContainer.appendChild(chartContainer);
                this.chartDiv = chartDiv;
            }
            
            initializeChart() {
                try {
                    // Create the chart with white theme
                    this.chart = LightweightCharts.createChart(this.chartDiv, {
                        width: this.chartDiv.offsetWidth,
                        height: 400,
                        layout: {
                            backgroundColor: '#ffffff',
                            textColor: '#333333',
                            fontSize: 12,
                        },
                        grid: {
                            vertLines: {
                                color: 'transparent',
                                visible: false,
                            },
                            horzLines: {
                                color: 'transparent', 
                                visible: false,
                            },
                        },
                        crosshair: {
                            mode: LightweightCharts.CrosshairMode.Normal,
                        },
                        rightPriceScale: {
                            borderColor: '#dddddd',
                            textColor: '#333333',
                        },
                        leftPriceScale: {
                            borderColor: '#dddddd',
                            textColor: '#333333',
                        },
                        timeScale: {
                            borderColor: '#dddddd',
                            timeVisible: true,
                            secondsVisible: true,
                            textColor: '#333333',
                        },
                    });
                    
                    // Add neon magenta price line
                    this.lineSeries = this.chart.addLineSeries({
                        color: '#ff00ff',
                        lineWidth: 2,
                        priceFormat: {
                            type: 'price',
                            precision: 2,
                            minMove: 0.01,
                        },
                    });
                    
                    // Add volume histogram
                    this.volumeSeries = this.chart.addHistogramSeries({
                        color: '#26a69a',
                        priceFormat: {
                            type: 'volume',
                            precision: 0,
                            minMove: 1,
                        },
                        priceScaleId: 'volume',
                        scaleMargins: {
                            top: 0.8, // Volume bars take bottom 20% of chart
                            bottom: 0,
                        },
                        base: 0,
                    });
                    
                    // Configure volume price scale to show actual trade sizes
                    this.chart.priceScale('volume').applyOptions({
                        scaleMargins: {
                            top: 0.8,
                            bottom: 0,
                        },
                        // Ensure the right price scale shows actual trade sizes, not normalized values
                        visible: true,
                        alignLabels: true,
                    });
                    
                    // Handle window resize
                    const resizeObserver = new ResizeObserver(entries => {
                        if (this.chart && this.chartDiv) {
                            this.chart.applyOptions({
                                width: this.chartDiv.offsetWidth,
                            });
                        }
                    });
                    resizeObserver.observe(this.chartDiv);
                    
                    // Add legend overlay functionality
                    this.addLegendOverlay();
                    
                    this.updateStatus('üìä Chart initialized with white theme and neon price line', 'success');
                    console.log('üìä Demo chart initialized successfully');
                } catch (error) {
                    console.error('‚ùå Error initializing chart:', error);
                    this.updateStatus('‚ùå Error initializing chart: ' + error.message, 'error');
                }
            }
            
            addPriceData(price, timestamp) {
                if (!this.chart || !this.lineSeries) return;
                
                // For LightweightCharts: convert local timestamp to UTC-adjusted timestamp
                // LightweightCharts interprets all timestamps as UTC and displays them in local time
                // So we need to subtract the timezone offset to get the correct display
                const date = new Date(timestamp);
                const timezoneOffsetMs = date.getTimezoneOffset() * 60 * 1000;
                const utcAdjustedTime = Math.floor((timestamp - timezoneOffsetMs) / 1000);
                
                const dataPoint = { time: utcAdjustedTime, value: parseFloat(price) };
                
                this.priceData.push(dataPoint);
                
                // Keep only last hour of data
                const cutoffTime = Math.floor((Date.now() - timezoneOffsetMs) / 1000) - 3600;
                this.priceData = this.priceData.filter(d => d.time > cutoffTime);
                
                // Sort and remove duplicates
                this.priceData.sort((a, b) => a.time - b.time);
                const uniqueData = this.priceData.filter((item, index, arr) => 
                    index === 0 || item.time !== arr[index - 1].time
                );
                
                this.lineSeries.setData(uniqueData);
                this.updatePriceDisplay(price);
            }
            
            addLegendOverlay() {
                if (!this.chart || !this.chartDiv) return;
                
                // Create legend container
                const legend = document.createElement('div');
                legend.style.cssText = `
                    position: absolute;
                    left: 12px;
                    top: 12px;
                    z-index: 1;
                    font-size: 14px;
                    font-family: sans-serif;
                    line-height: 18px;
                    font-weight: 300;
                    pointer-events: none;
                    background: rgba(255, 255, 255, 0.9);
                    padding: 8px 12px;
                    border-radius: 4px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                `;
                this.chartDiv.appendChild(legend);
                
                // Create price row
                const priceRow = document.createElement('div');
                priceRow.innerHTML = `DEMO STOCK <strong>--</strong>`;
                priceRow.style.color = '#ff00ff';
                priceRow.style.fontWeight = '500';
                legend.appendChild(priceRow);
                
                // Create volume row
                const volumeRow = document.createElement('div');
                volumeRow.innerHTML = `Volume <strong>--</strong>`;
                volumeRow.style.color = '#666';
                volumeRow.style.fontSize = '12px';
                volumeRow.style.marginTop = '4px';
                legend.appendChild(volumeRow);
                
                // Subscribe to crosshair move events
                this.chart.subscribeCrosshairMove(param => {
                    if (param.time) {
                        // Get price data
                        const priceData = param.seriesData.get(this.lineSeries);
                        let priceFormatted = '--';
                        if (priceData && priceData.value !== undefined) {
                            priceFormatted = `‚Ç¨${priceData.value.toFixed(2)}`;
                        }
                        
                        // Get volume data and trade information
                        const volumeData = param.seriesData.get(this.volumeSeries);
                        let volumeFormatted = '--';
                        let volumeColor = '#666';
                        
                        if (volumeData && volumeData.value !== undefined) {
                            // Look up trade data for this specific time
                            const tradeData = this.tradeTooltipData.get(param.time);
                            if (tradeData) {
                                // Always show actual trade size, not the normalized volume
                                // Convert the chart time back to local time for display
                                const chartTimeMs = param.time * 1000;
                                const localTime = new Date(chartTimeMs + (new Date().getTimezoneOffset() * 60 * 1000));
                                const timeString = localTime.toLocaleTimeString();
                                
                                volumeFormatted = `${tradeData.size.toLocaleString()} @ ‚Ç¨${tradeData.price.toFixed(2)} (${timeString})`;
                                volumeColor = tradeData.side === 'buy' ? '#00ff00' : 
                                             tradeData.side === 'sell' ? '#ff0000' : '#666';
                                
                                const sideText = tradeData.side.toUpperCase();
                                volumeFormatted = `${sideText} ${volumeFormatted}`;
                                
                                // Also update price to show trade price when hovering volume
                                priceFormatted = `‚Ç¨${tradeData.price.toFixed(2)}`;
                            } else {
                                // Show message when no trade data available
                                volumeFormatted = `No trade data`;
                            }
                        }
                        
                        // Update legend
                        priceRow.innerHTML = `DEMO STOCK <strong>${priceFormatted}</strong>`;
                        volumeRow.innerHTML = `Volume <strong style="color: ${volumeColor}">${volumeFormatted}</strong>`;
                    } else {
                        // Reset to default when not hovering
                        priceRow.innerHTML = `DEMO STOCK <strong>--</strong>`;
                        volumeRow.innerHTML = `Volume <strong>--</strong>`;
                    }
                });
            }
            
            addTradeData(price, size, side, timestamp) {
                if (!this.chart || !this.volumeSeries) return;
                
                // For LightweightCharts: convert local timestamp to UTC-adjusted timestamp
                // LightweightCharts interprets all timestamps as UTC and displays them in local time
                // So we need to subtract the timezone offset to get the correct display
                const date = new Date(timestamp);
                const timezoneOffsetMs = date.getTimezoneOffset() * 60 * 1000;
                const utcAdjustedTime = Math.floor((timestamp - timezoneOffsetMs) / 1000);
                
                // Color-coded volume bars
                let color = '#808080'; // Gray for unknown
                if (side === 'buy') color = '#00ff00'; // Green for buy
                if (side === 'sell') color = '#ff0000'; // Red for sell
                
                // Use actual trade size for the chart (no normalization)
                const actualSize = parseFloat(size);
                
                const volumePoint = { time: utcAdjustedTime, value: actualSize, color };
                
                // Store trade data for tooltip lookup
                this.tradeTooltipData.set(utcAdjustedTime, {
                    price: parseFloat(price),
                    size: parseFloat(size),
                    side: side,
                    timestamp: timestamp
                });
                
                this.volumeData.push(volumePoint);
                
                // Keep only last hour and clean up tooltip data
                const now = new Date();
                const nowTimezoneOffsetMs = now.getTimezoneOffset() * 60 * 1000;
                const cutoffTime = Math.floor((Date.now() - nowTimezoneOffsetMs) / 1000) - 3600;
                this.volumeData = this.volumeData.filter(v => v.time > cutoffTime);
                
                // Clean up old tooltip data
                for (const [time, data] of this.tradeTooltipData) {
                    if (time <= cutoffTime) {
                        this.tradeTooltipData.delete(time);
                    }
                }
                this.volumeData.sort((a, b) => a.time - b.time);
                
                this.volumeSeries.setData(this.volumeData);
            }
            
            updatePriceDisplay(price) {
                const priceElement = document.getElementById('current-price');
                const changeElement = document.getElementById('price-change');
                const updateElement = document.getElementById('last-update');
                
                const change = price - this.basePrice;
                const changePercent = (change / this.basePrice) * 100;
                
                priceElement.textContent = `‚Ç¨${price.toFixed(2)}`;
                changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
                changeElement.className = `price-change ${change >= 0 ? '' : 'negative'}`;
                updateElement.textContent = new Date().toLocaleTimeString();
                
                this.currentPrice = price;
            }
            
            updateStatus(message, type = 'info') {
                const statusElement = document.getElementById('status');
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
            }
        }
        
        // Global demo instance
        let demoChart = null;
        
        // Initialize demo when page loads
        window.addEventListener('load', () => {
            demoChart = new DemoChart();
            
            // Start time display updater
            updateTimeDisplay();
            setInterval(updateTimeDisplay, 1000);
            
            // Add some initial data points so the chart isn't empty
            setTimeout(() => {
                if (demoChart && demoChart.chart) {
                    const now = Date.now();
                    const basePrice = 1625.50;
                    
                    // Add some historical price points (last 30 minutes)
                    for (let i = 30; i >= 0; i--) {
                        const timestamp = now - (i * 60 * 1000); // i minutes ago
                        const price = basePrice + (Math.random() - 0.5) * 10; // Random price around base
                        demoChart.addPriceData(price, timestamp);
                        
                        // Add some random trades
                        if (i % 5 === 0 && i > 0) {
                            const side = Math.random() > 0.5 ? 'buy' : 'sell';
                            const size = Math.floor(Math.random() * 200) + 50;
                            demoChart.addTradeData(price, size, side, timestamp);
                        }
                    }
                    
                    demoChart.updateStatus('üìä Demo chart loaded with initial data', 'success');
                }
            }, 500); // Small delay to ensure chart is fully initialized
        });
        
        function updateTimeDisplay() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }
        
        // Demo control functions
        function startDemo() {
            if (demoChart.isRunning) {
                clearInterval(demoChart.intervalId);
                demoChart.isRunning = false;
                demoChart.updateStatus('‚è∏Ô∏è Demo paused', 'info');
                document.querySelector('.btn-primary').textContent = 'üöÄ Start Live Demo';
                return;
            }
            
            demoChart.isRunning = true;
            demoChart.updateStatus('‚ñ∂Ô∏è Live demo running - generating random price movements', 'success');
            document.querySelector('.btn-primary').textContent = '‚è∏Ô∏è Pause Demo';
            
            // Generate realistic price movements
            demoChart.intervalId = setInterval(() => {
                const now = Date.now();
                const change = (Math.random() - 0.5) * 2; // Random change between -1 and +1
                const newPrice = Math.max(1600, Math.min(1650, demoChart.currentPrice + change));
                
                demoChart.addPriceData(newPrice, now);
                
                // Occasionally add volume data
                if (Math.random() < 0.3) {
                    const side = Math.random() > 0.5 ? 'buy' : 'sell';
                    const size = Math.floor(Math.random() * 500) + 100;
                    demoChart.addTradeData(newPrice, size, side, now);
                }
            }, 1000);
        }
        
        function simulateBuyTrade() {
            const now = Date.now();
            const size = Math.floor(Math.random() * 1000) + 200;
            const price = demoChart.currentPrice + (Math.random() * 0.5);
            
            demoChart.addTradeData(price, size, 'buy', now);
            demoChart.addPriceData(price, now);
            demoChart.updateStatus(`üü¢ Simulated BUY trade: ${size} shares at ‚Ç¨${price.toFixed(2)}`, 'success');
        }
        
        function simulateSellTrade() {
            const now = Date.now();
            const size = Math.floor(Math.random() * 1000) + 200;
            const price = demoChart.currentPrice - (Math.random() * 0.5);
            
            demoChart.addTradeData(price, size, 'sell', now);
            demoChart.addPriceData(price, now);
            demoChart.updateStatus(`üî¥ Simulated SELL trade: ${size} shares at ‚Ç¨${price.toFixed(2)}`, 'info');
        }
        
        function clearChart() {
            if (demoChart.intervalId) {
                clearInterval(demoChart.intervalId);
                demoChart.isRunning = false;
            }
            
            demoChart.priceData = [];
            demoChart.volumeData = [];
            demoChart.currentPrice = demoChart.basePrice;
            
            if (demoChart.lineSeries) demoChart.lineSeries.setData([]);
            if (demoChart.volumeSeries) demoChart.volumeSeries.setData([]);
            
            demoChart.updatePriceDisplay(demoChart.basePrice);
            demoChart.updateStatus('üßπ Chart cleared - ready for new data', 'info');
            document.querySelector('.btn-primary').textContent = 'üöÄ Start Live Demo';
        }
    </script>
</body>
</html>
